---
title: ""
output: 
  html_document:
      css: tt_css.css
runtime: shiny
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

# https://github.com/juftin/camply

library(reticulate)
library(tidyverse)
library(reactable)
library(DT)
library(shiny)
library(emo)

use_virtualenv("r-reticulate")

```


<head>
<link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet"> 
</head>

<style type="text/css">
.main-container {
  max-width: 1200px;
  margin-left: auto;
  margin-right: auto;
}
</style>

# `r paste("Raystown Lake Campsite Availability", emo::ji("camping"))`

#### Searching all loops at Raystown between April - Sept 2022:

```{python eval = T}

import datetime
import logging
from typing import List
import pandas as pd

from camply.containers import AvailableCampsite, SearchWindow
from camply.search import SearchRecreationDotGov

# logging.basicConfig(format="%(asctime)s [%(levelname)8s]: %(message)s",
#                     level=logging.INFO)

search_range = SearchWindow(start_date=datetime.datetime(year = 2022, month = 4, day = 1),
                             end_date=datetime.datetime(year = 2022, month = 9, day = 30))
                             
camping_finder = SearchRecreationDotGov(search_window = search_range,
                                        recreation_area = 187,  # raystown lake
                                        campgrounds = 233626, # seven points
                                        weekends_only = False,
                                        nights = 5)
                                        
# match: List[AvailableCampsite] = camping_finder.get_matching_campsites(log=False, verbose=True, continuous=False)

results = camping_finder.get_matching_campsites(log = True, verbose = True, continuous = False)

results_df = pd.DataFrame(results)

```

`r shiny::hr()` 

## Filterable Results

```{r inputs}
campsites <- 
  c("SENO", "PCAM", "RCAM", "MCAM", "VCAM", "BCAM")

# months  <-
#   tibble(
#     date = seq(Sys.Date(), Sys.Date() + 400, "1 month")) %>%
#   mutate(month = month(date, abbr = T, label = T)) %>%
#   distinct(month) %>%
#   pull(month) 

shiny::selectInput(inputId = "campsite_select", choices = sort(campsites), label = "Loop", multiple = T, selected = "SENO")
# shiny::numericInput(inputId = "night_select", label = "Nights", value = 4, min = 1, step = 1)
# shiny::selectInput(inputId = "month_select", label = "Month", choices = months, selected = month(Sys.Date(), label = T, abbr = T), multiple = T)

```

```{r eval = T}
DT::renderDataTable(
  py$results_df %>% 
    select(-campsite_occupancy) %>% 
    filter(campsite_loop_name == input$campsite_select) %>%
  mutate(booking_date = as.Date(booking_date),
         booking_end_date = as.Date(booking_end_date)) %>%
    select(booking_date, booking_end_date, campsite_loop_name, campsite_site_name, booking_url) %>%
    mutate(booking_url = paste0("<a href='", booking_url, " 'target='_blank'> Book Site </a>")) %>%
    datatable(., escape = F, rownames = F) 
)
```

